# 2025-12-04 HTTPS 部署里程碑 (HTTPS Deployment Milestone)

**目標**: 將 VPS 上的 PhpStudy 面板升級為 HTTPS，並透過 Cloudflare 進行安全防護。
**日期**: 2025-12-04
**狀態**: ✅ 完成 (Completed)

## 1. 基礎設施資訊 (Infrastructure)
- **VPS IP**: `72.60.198.67`
- **域名 (Domain)**: `xp.gofun.cloud` (用於面板存取)
- **Cloudflare 設定**:
  - DNS Record: `A` 紀錄指向 VPS IP。
  - Proxy Status: ✅ Proxied (橘雲開啟)。
  - SSL/TLS Mode: Full (Strict) 或 Full。

## 2. 實作步驟 (Implementation Steps)

### A. 安全性與版本控制 (Security & Git)
- **Git 清理**: 將敏感檔案 (`credentials.txt`, `DEVELOPMENT_LOG.md`) 加入 `.gitignore` 並從遠端倉庫移除，確保憑證不外洩。
- **憑證管理**: 更新 `credentials.txt`，區分「本地開發環境」與「VPS 線上環境」的登入資訊。

### B. Docker 環境建置 (Docker Setup)
- **映像檔構建**: 建立 `phpstudy-vps` 映像檔，預先安裝 `openssh-server` 等必要工具。
- **端口映射 (Port Mapping)**:
  - 由於 Cloudflare 支援的 HTTPS 端口有限，我們將宿主機的 `8443` 端口映射到容器的 `9080` (面板默認端口)。
  - `8443:9080` (面板 HTTPS)
  - `80:80`, `443:443` (未來網站流量)

### C. SSL 憑證簽發 (SSL Certificate Generation)
- **工具**: 使用 `acme.sh` (ZeroSSL CA)。
- **流程**:
  1. 在容器內安裝 `cron` 與 `socat`。
  2. 註冊 ZeroSSL 帳戶。
  3. 使用 Standalone 模式簽發憑證 (需暫時關閉佔用 80 端口的服務)。
  4. 憑證安裝路徑:
     - CRT: `/www/ssl/xp_panel.crt`
     - Key: `/www/ssl/xp_panel.key`

### D. 面板強制 HTTPS (Enforcing HTTPS on Panel)
- **問題**: PhpStudy 面板 (WorkerMan 架構) 介面無 SSL 設定選項。
- **解決方案**: 直接修改後端啟動腳本 `/usr/local/phpstudy/web/service/httpServer/start.php`。
- **代碼變更**:
  ```php
  // SSL Config
  $context = array();
  if (file_exists('/www/ssl/xp_panel.crt') && file_exists('/www/ssl/xp_panel.key')) {
      $context = array(
          'ssl' => array(
              'local_cert'  => '/www/ssl/xp_panel.crt',
              'local_pk'    => '/www/ssl/xp_panel.key',
              'verify_peer' => false,
              'verify_peer_name' => false,
          )
      );
  }
  // 傳入 context 啟用 SSL
  $webserver = new WebServer('http://0.0.0.0:'.$port, $context);
  if (!empty($context)) {
      $webserver->transport = 'ssl';
  }
  ```

### E. 修正存取權限 (Access Control)
- **密碼重置**: 透過 `phpstudyctl -initpwd` 重置面板密碼。
- **解除綁定**: 透過 `phpstudyctl -canceldomain` 解除域名綁定限制，允許 IP 直接訪問 (緊急備用)。

## 3. 最終成果 (Outcome)
- **面板登入網址**: `https://xp.gofun.cloud:8443/83CA22`
- **安全性**:
  - 傳輸層已加密 (TLS 1.2/1.3)。
  - 真實 IP 被 Cloudflare 隱藏。
  - 瀏覽器顯示安全鎖頭 🔒。

## 4. 待辦事項 (Next Steps)
- [ ] 在面板內安裝 LNMP 環境 (Nginx, MySQL, PHP)。
- [ ] 部署 `gofun.cloud` 主站點內容。
- [ ] 設置主站點的 HTTPS (Nginx 配置)。
